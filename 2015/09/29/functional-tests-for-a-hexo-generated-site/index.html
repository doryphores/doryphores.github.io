<!DOCTYPE html><html><head><meta charset="utf-8"><title>Writing functional tests for a Hexo generated site | 1 Pixel Out</title><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="google-site-verification" content="9uT0USrsuq15SPod2KGvcaLyQuHi9lJo_FXn5oNR67A"><meta name="description" content="A quick overview of how to write functional tests for a Hexo site using cucumber.js, zombie.js and CoffeeScript"/><meta property="og:site_name" content="1 Pixel Out"/><meta property="og:type" content="article"/><meta property="og:title" content="Writing functional tests for a Hexo generated site"/><meta property="og:url" content="http://1pixelout.net/2015/09/29/functional-tests-for-a-hexo-generated-site/"/><meta property="og:description" content="A quick overview of how to write functional tests for a Hexo site using cucumber.js, zombie.js and CoffeeScript"/><meta property="og:updated_time" content="2015-10-28T14:35:00.000Z"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@doryphores"/><meta name="twitter:title" content="Writing functional tests for a Hexo generated site"/><meta name="twitter:description" content="A quick overview of how to write functional tests for a Hexo site using cucumber.js, zombie.js and CoffeeScript"/><link rel="alternative" href="/atom.xml" title="1 Pixel Out" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css"></head><body><div class="site-wrapper"><header class="c-site-header"><div class="c-site-header__branding"><a href="/">1 Pixel Out</a></div><a href="/atom.xml" title="RSS Feed" class="c-site-header__rss-link"><i class="icon-rss"></i></a><nav class="c-site-nav"><ul class="u-list--horizontal"><li class="c-site-nav__item"><a href="/">Latest post</a></li><li class="c-site-nav__item"><a href="/archives">Browse posts</a></li><li class="c-site-nav__item"><a href="/about">About</a></li></ul></nav></header><section><article class="article" itemscope="itemscope" itemtype="http://schema.org/BlogPosting"><header class="o-page-header"><h1 itemprop="name headline" class="o-page-header__title">Writing functional tests for a Hexo generated site</h1><div class="article__meta"><span class="article__date"><span class="u-mobile-hide">Published</span> <time datetime="2015-09-29T13:18:24.000Z" itemprop="datePublished">Sep 29th 2015</time></span><span class="article__author">By <strong itemprop="author">Martin Laine</strong></span><span class="o-tag-list">Tagged as:&nbsp;<a href="/tags/cucumber/" class="o-tag-list__item">cucumber</a><a href="/tags/hexo/" class="o-tag-list__item">hexo</a></span></div></header><div itemprop="articleBody" class="article__body"><p>This is just a quick overview of how to write functional tests for a Hexo site.</p>
<p>We will use:</p>
<ul>
<li><a href="https://github.com/cucumber/cucumber-js" target="_blank" rel="external">cucumber.js</a> for running the features</li>
<li><a href="http://zombie.js.org/" target="_blank" rel="external">zombie.js</a> as a headless browser</li>
<li><a href="http://coffeescript.org/" target="_blank" rel="external">CoffeeScript</a> to write the step definitions</li>
</ul>
<p><em><strong>Note</strong>: The latest version of zombie.js only runs on iojs so if you you want to stick to node, pin it to version 3.x.</em></p>
<h2 id="The_feature">The feature</h2><p>Let’s start with the following feature. It tests that the home page shows the latest article. It does this by visiting the home page, asserting that there is a single article on the page, clicking its title and checking that the article page does not have a “Newer post” link (i.e. it is the latest).</p>
<figure class="highlight feature"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Feature</span>: The generated site is OK to deploy</span><br><span class="line">  As the owner of myblog.com</span><br><span class="line">  I want to check that the generated site is OK</span><br><span class="line">  So that I am confident it is OK to deploy</span><br><span class="line"></span><br><span class="line">  <span class="keyword">Background</span>:</span><br><span class="line">    <span class="keyword">Given</span> I am on the <span class="string">"myblog.com"</span> website</span><br><span class="line"></span><br><span class="line">  <span class="keyword">Scenario</span>: The home page shows the latest article</span><br><span class="line">    <span class="keyword">When</span> I visit the home page</span><br><span class="line">    <span class="keyword">Then</span> I can see a single article</span><br><span class="line">    <span class="keyword">When</span> I click the article title</span><br><span class="line">    <span class="keyword">Then</span> I am on the newest article page</span><br></pre></td></tr></table></figure>
<h2 id="Starting_and_stopping_the_local_hexo_server">Starting and stopping the local hexo server</h2><p>To start the server, we use a before hook (in <code>features/support/hooks.coffee</code>):</p>
<figure class="highlight coffee"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Hexo = <span class="built_in">require</span>(<span class="string">"hexo"</span>)</span><br><span class="line"></span><br><span class="line">SERVER_PORT = <span class="number">4040</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">-&gt;</span></span><br><span class="line">  serverIsReady = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a new silent Hexo instance (we don't want any output)</span></span><br><span class="line">  hexo = <span class="keyword">new</span> Hexo process.cwd(),</span><br><span class="line">    <span class="attribute">silent</span>: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="property">@Before</span> -&gt;</span><br><span class="line">    <span class="comment"># We need to server port to configure zombie later on</span></span><br><span class="line">    <span class="property">@serverPort</span> = SERVER_PORT</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Do nothing if the server is ready</span></span><br><span class="line">    <span class="keyword">return</span> Promise.resolve() <span class="keyword">if</span> serverIsReady</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialise hexo, clean generated files and start a local server</span></span><br><span class="line">    hexo.init()</span><br><span class="line">    .<span class="keyword">then</span> -&gt; hexo.call(<span class="string">"clean"</span>, &#123;&#125;)</span><br><span class="line">    .<span class="keyword">then</span> -&gt; hexo.call(<span class="string">"server"</span>, &#123; <span class="attribute">port</span>: SERVER_PORT &#125;)</span><br><span class="line">    .<span class="keyword">then</span> -&gt; serverIsReady = <span class="literal">true</span></span><br><span class="line">    .<span class="keyword">catch</span> (err) -&gt;</span><br><span class="line">      <span class="comment"># An error occurred so exit hexo and return a rejection</span></span><br><span class="line">      hexo.exit()</span><br><span class="line">      Promise.reject(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Close the hexo local server when everything is done</span></span><br><span class="line">  <span class="property">@registerHandler</span> <span class="string">"AfterFeatures"</span>, <span class="function"><span class="params">(event, callback)</span> -&gt;</span></span><br><span class="line">    hexo.exit().<span class="keyword">then</span>(callback)</span><br></pre></td></tr></table></figure>
<h2 id="The_browser_instance">The browser instance</h2><p>We use a background step to setup the browser:</p>
<figure class="highlight feature"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Background</span>:</span><br><span class="line">  <span class="keyword">Given</span> I am on the <span class="string">"myblog.com"</span> website</span><br></pre></td></tr></table></figure>
<p>Here’s the background step definition:</p>
<figure class="highlight coffee"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Browser = <span class="built_in">require</span>(<span class="string">"zombie"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">-&gt;</span></span><br><span class="line">  <span class="property">@Given</span> <span class="regexp">/I am on the "(.*?)" website/</span>, <span class="function"><span class="params">(domain, done)</span> -&gt;</span></span><br><span class="line">    Browser.localhost(domain, <span class="property">@serverPort</span>)</span><br><span class="line">    <span class="property">@browser</span> = <span class="keyword">new</span> Browser()</span><br><span class="line">    done()</span><br></pre></td></tr></table></figure>
<p>zombie.js has a <a href="https://github.com/assaf/zombie#browserlocalhosthost-port" target="_blank" rel="external"><code>localhost</code></a> method to configure the browser to route requests to a local server. This is where we need <code>@serverPort</code> from the <code>Before</code> hook defined earlier.</p>
<h2 id="The_step_definitions">The step definitions</h2><p>Now that we have configured the browser instance, we can write the steps. CoffeeScript is great for writing steps or spec examples as it does away with all the syntax noise and we’re left with the essential information.</p>
<figure class="highlight coffee"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Browser = <span class="built_in">require</span>(<span class="string">"zombie"</span>)</span><br><span class="line">expect  = <span class="built_in">require</span>(<span class="string">"chai"</span>).expect</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">-&gt;</span></span><br><span class="line">  <span class="property">@Given</span> <span class="regexp">/^I am on the "(.*?)" website$/</span>, <span class="function"><span class="params">(domain)</span> -&gt;</span></span><br><span class="line">    Browser.localhost(domain, <span class="property">@serverPort</span>)</span><br><span class="line">    <span class="property">@browser</span> = <span class="keyword">new</span> Browser()</span><br><span class="line"></span><br><span class="line">  <span class="property">@Given</span> <span class="regexp">/^I visit the home page$/</span>, <span class="function">-&gt;</span></span><br><span class="line">    <span class="property">@browser</span>.visit(<span class="string">"/"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="property">@Then</span> <span class="regexp">/^I can see a single article$/</span>, <span class="function">-&gt;</span></span><br><span class="line">    <span class="property">@browser</span>.assert.elements(<span class="string">"article"</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="property">@When</span> <span class="regexp">/^I click the article title$/</span>, <span class="function">-&gt;</span></span><br><span class="line">    <span class="property">@browser</span>.clickLink(<span class="string">"article h1 a"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="property">@Then</span> <span class="regexp">/^I am on the newest article page$/</span>, <span class="function">-&gt;</span></span><br><span class="line">    expect(<span class="property">@browser</span>.link(<span class="string">"Newer post"</span>)).<span class="keyword">not</span>.to.exist</span><br></pre></td></tr></table></figure>
<h2 id="The_deploy_script">The deploy script</h2><p>We can now define <code>test</code> and <code>deploy</code> npm commands. In your <code>package.json</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">scripts</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">start</span>": <span class="value"><span class="string">"hexo server --draft"</span></span>,</span><br><span class="line">    "<span class="attribute">test</span>": <span class="value"><span class="string">"cucumberjs --compiler coffee:coffee-script/register"</span></span>,</span><br><span class="line">    "<span class="attribute">deploy</span>": <span class="value"><span class="string">"cucumberjs -f progress --compiler coffee:coffee-script/register &amp;&amp; hexo deploy --generate"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>Now, when you run the following command, cucumberjs will run your features and deploy if they all pass:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#62; npm run deploy</span><br></pre></td></tr></table></figure>
<p>To run the tests by themselves:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#62; npm test</span><br></pre></td></tr></table></figure>
</div></article><nav class="o-pagination"><div class="o-pagination__social"><a href="http://twitter.com/share?text=Writing%20functional%20tests%20for%20a%20Hexo%20generated%20site&amp;url=http%3A%2F%2F1pixelout.net%2F2015%2F09%2F29%2Ffunctional-tests-for-a-hexo-generated-site%2F" onclick="window.open(this.href, 'twitter-share', 'width=550,height=435');return false;" title="Post to Twitter" class="o-pagination__link"><i class="o-pagination__link-icon icon-twitter"></i><span class="u-mobile-hide">Post to Twitter</span></a><a id="js-toggle-comments" href="#" class="o-pagination__link"><i class="o-pagination__link-icon icon-comments"></i><span class="u-mobile-hide">Comments<span data-disqus-url="http://1pixelout.net/2015/09/29/functional-tests-for-a-hexo-generated-site/" class="o-pagination__link-count disqus-comment-count"></span></span></a></div><a id="qa-newer" href="/2015/10/02/simple-breakpoint-media-queries-with-stylus/" class="o-pagination__link o-pagination__link--prev"><i class="o-pagination__link-icon icon-left"></i><span class="o-pagination__link-label">Newer</span><span class="o-pagination__link-title">Simple breakpoint media queries with Stylus</span></a><a id="qa-older" href="/2015/09/18/writing-hexo-template-helpers/" class="o-pagination__link o-pagination__link--next"><span class="o-pagination__link-label">Older</span><i class="o-pagination__link-icon icon-right"></i><span class="o-pagination__link-title">Writing hexo template helpers</span></a></nav><div id="js-comment-box" tabindex="-1" class="o-comment-box"><div id="disqus_thread" class="o-comment-box__thread"><noscript>Please enable JavaScript to view the
<a href="//disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript></div></div><script>var disqus_shortname = "1pixelout";
var disqus_title = "Writing functional tests for a Hexo generated site";
var disqus_url = "http://1pixelout.net/2015/09/29/functional-tests-for-a-hexo-generated-site/";</script></section></div><footer class="c-site-footer"><p>&copy; 2015 Martin Laine</p><p>Powered by
<a href="http://hexo.io/" target="_blank">Hexo</a>
and
<a href="https:/github.com/" target="_blank">GitHub</a></p><p>Theme inspired by
<a href="http://ghost.jollygoodthemes.com/ghostwriter/" target="_blank">Ghostwriter</a>
from
<a href="http://ghost.jollygoodthemes.com/" target="_blank">JollyGoodThemes</a></p></footer><script src="/js/app.js"></script></body></html>